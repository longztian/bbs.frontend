(function(a){a.fn.imageCropper=function(l){var e=a.extend({defaultImage:null,windowHeight:120,windowWidth:120,uploadURL:null,uploadName:"base64Image"},l);var b=a(this),m=null,h=null,c=document.createElement("IMG"),g=a('<div class="tools"><button class="zoomin"><span class="icon-resize-full"></span></button><button class="zoomout"><span class="icon-resize-small"></span></button><button class="crop"><span class="icon-ok"></span></button><button class="reset"><span class="icon-cancel"></span></button></div>');function d(s){s.preventDefault();var o=(s.originalEvent.touches||s.originalEvent.changedTouches)?s.originalEvent.touches[0]||s.originalEvent.changedTouches[0]:s;var u=m.offset().top,p=m.offset().left,q=o.pageY,r=o.pageX,w=b.offset().top,n=b.offset().left,t=w+e.windowHeight-m.innerHeight(),v=n+e.windowWidth-m.innerWidth();m.on({"dragstart mousemove touchmove":function(z){z.stopImmediatePropagation();z.preventDefault();var y=(z.originalEvent.touches||z.originalEvent.changedTouches)?z.originalEvent.touches[0]||z.originalEvent.changedTouches[0]:z;var x=y.pageY-q+u,A=y.pageX-r+p;if(x<t){x=t}else{if(x>w){x=w}}if(A<v){A=v}else{if(A>n){A=n}}m.offset({top:x,left:A});h.offset({top:x,left:A})},"dragend mouseup touchend":function(){m.unbind("mousemove touchmove")}})}function i(s){if(this.height<e.windowHeight||this.width<e.windowWidth){alert("图片尺寸太小，最小图片尺寸为 "+e.windowWidth+"x"+e.windowHeight+" 像素");return}if(e.windowHeight==this.height&&e.windowWidth==this.width){if(!h){h=a('<img class="bg-image">').css("width",e.windowWidth).css("height",e.windowHeight).attr("src",this.src).prependTo(b)}else{h.attr("src",this.src)}if(e.uploadURL){var r={};r[e.uploadName]=this.src;a.post(e.uploadURL,r)}}else{var q=Math.max(e.windowHeight/this.height,e.windowWidth/this.width);if(q>0.9){q=1}else{q=q*1.1}var n=this.height*q,o=this.width*q,p=b.offset().top+(e.windowHeight-n)/2,t=b.offset().left+(e.windowWdith-o)/2;if(!h){h=a('<img class="bg-image">').attr("src",this.src).css("opacity",0.2).prependTo(b)}else{h.attr("src",this.src).css("opacity",0.2)}b.append('<div class="crop-window"><img class="fg-image" src="'+this.src+'"></div>');m=b.find("img.fg-image");m.css("height",n).css("width",o);h.css("height",n).css("width",o);m.offset({top:p,left:t});h.offset({top:p,left:t});m.bind("mousedown touchstart",d);g.appendTo(b).css("position","absolute").offset({top:b.offset().top+e.windowHeight,left:b.offset().left})}}function k(s){if(!m){return}var v=m.innerHeight(),p=m.innerWidth(),o=v*s,q=p*s;if(s<1){if(o<e.windowHeight){o=e.windowHeight;s=o/v;q=p*s}if(q<e.windowWidth){q=e.windowWidth;s=q/p;o=v*s}}var x=b.offset().top,n=b.offset().left,t=x+b.innerHeight()/2,u=n+b.innerWidth()/2,r=t+(m.offset().top-t)*s,w=u+(m.offset().left-u)*s;if(s<1){if(r>x){r=x}if(w>n){w=n}}m.css("height",o).css("width",q);m.offset({top:r,left:w});h.css("height",o).css("width",q);h.offset({top:r,left:w})}function f(){if(!m){return}var n=document.createElement("canvas"),q=c.width/m.innerWidth(),p=(b.offset().left-m.offset().left)*q,o=(b.offset().top-m.offset().top)*q;n.width=e.windowWidth*q;n.height=e.windowHeight*q;n.getContext("2d").drawImage(c,p,o,n.width,n.height,0,0,n.width,n.height);var r=document.createElement("canvas");r.width=e.windowWidth;r.height=e.windowHeight;window.pica.resizeCanvas(n,r,function(s){if(s){alert("图片缩放失败: "+s);return}c=null;c=document.createElement("IMG");var t=r.toDataURL("image/png");h.css("width",e.windowWidth).css("height",e.windowHeight).css("opacity",1).attr("src",t).offset({top:b.offset().top,left:b.offset().left});b.find("div.crop-window").remove();g.detach();if(e.uploadURL){var u={};u[e.uploadName]=t;a.post(e.uploadURL,u)}})}function j(){if(e.defaultImage){h=a('<img class="bg-image">').attr("src",e.defaultImage).css("width",e.windowWidth).css("height",e.windowHeight).prependTo(b)}a('<input type="file" name="image">').appendTo(b).on("change",function(p){var o=p.originalEvent.target.files[0];var n=new FileReader();n.onload=function(q){c.onload=i;c.src=q.target.result};n.readAsDataURL(o)})}b.css("width",e.windowWidth).css("height",e.windowHeight);j();g.find(".zoomin").on("click",function(n){k(1.1)});g.find(".zoomout").on("click",function(n){k(0.9)});g.find(".crop").on("click",function(n){f()});g.find(".reset").on("click",function(n){g.detach();b.empty();j()})}}(jQuery));